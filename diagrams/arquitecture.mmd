---
config:
  layout: elk
  theme: base
---
flowchart LR
%% ─────────────────────────── LAYOUT OVERVIEW ───────────────────────────
subgraph DataLake["🪣 Data Lake"]
  BRONZE["BRONZE<br/>personal-raw-…-youtubeapi"]
  SILVER["SILVER<br/>personal-cleaned-…-youtubeapi"]
  GOLD["GOLD<br/>personal-analytics-…-youtubeapi"]
end

subgraph DataCatalog["📚: Data Catalog (Glue)"]
  subgraph BRONZEDB["DB: dl_raw"]
    BRONZETABLEJSON["Table: raw_statistics_reference_data"]
    BRONZETABLECSV["Table: raw_statistics"]
  end
  subgraph SILVERDB["DB: dl_cleaned"]
    SILVERTABLEJSON["Table: cleaned_statistics_reference_data"]
    SILVERTABLECSV["Table: cleaned_statistics"]
  end
  subgraph GOLDDB["DB: dl_analytics"]
    GOLDTABLE["Table: final_analytics"]
  end
end

subgraph Ingestion["⚡ Ingestion"]
  TRIGGER1["⏰ EventBridge<br/>5:00 AM CT"]
  API["🧩 YouTube Data API v3"]
  FUNCTION1["λ youtube_api_fetch_raw"]
end

subgraph PROCESSING["🛠️ Processing"]
  %% RAW ORCHESTRATOR
  subgraph RAW_ORCH["λ Raw Orchestrator"]
    LAMBDA2["json_to_parquet<br/>+ start_csv_to_parquet"]
    RAW_LAMBDA_FUNCTION["Function: Transform JSON"]
    subgraph RAW_JOBS["🧪 Glue Jobs (Raw)"]
      JOB_CSV_PARQ["CSV → Parquet"]
    end
    subgraph RAW_CRAWLERS["🕷️ Crawlers (Raw)"]
      CRAWL_RAW_JSON["Crawler: Raw JSON"]
      CRAWL_RAW_CSV["Crawler: Raw CSV"]
    end
  end

  %% CLEAN ORCHESTRATOR
  subgraph CLEAN_ORCH["λ Cleaned Orchestrator"]
    LAMBDA3["catalog_cleaned<br/>+ run_analytics_join"]
    subgraph CLEAN_JOBS["🧪 Glue Jobs (Cleaned)"]
      JOB_JOIN["Analytics join on category_id"]
    end
    subgraph CLEAN_CRAWLERS["🕷️ Crawler (Cleaned)"]
      CRAWL_CLEAN["Crawler: Cleaned Parquet"]
    end
  end
end

ANALYTICS["🔎 Athena / QuickSight"]

%% ─────────────────────────── EVENT TRIGGERS ───────────────────────────
S3EVT_RAW["🔔 S3 Event (BRONZE)<br/>ObjectCreated:* (e.g., *.json, *.csv)"]
S3EVT_CLEAN["🔔 S3 Event (SILVER)<br/>ObjectCreated:* (e.g., *.parquet)"]

%% ─────────────────────────── FLOWS ───────────────────────────
TRIGGER1 -- "schedule" --> FUNCTION1
FUNCTION1 --> API
FUNCTION1 --> BRONZE

%% Raw pipeline (event-driven)
BRONZE -- "S3 notification" --> S3EVT_RAW
S3EVT_RAW -. "trigger" .-> LAMBDA2
LAMBDA2 --> RAW_LAMBDA_FUNCTION
RAW_LAMBDA_FUNCTION --> SILVER
LAMBDA2 --> JOB_CSV_PARQ
LAMBDA2 --> CRAWL_RAW_JSON
LAMBDA2 --> CRAWL_RAW_CSV

CRAWL_RAW_JSON --> BRONZETABLEJSON
CRAWL_RAW_CSV --> BRONZETABLECSV
JOB_CSV_PARQ --> SILVER

%% Cleaned / analytics pipeline (event-driven)
SILVER -- "S3 notification" --> S3EVT_CLEAN
S3EVT_CLEAN -. "trigger" .-> LAMBDA3
LAMBDA3 --> CRAWL_CLEAN
LAMBDA3 --> JOB_JOIN

RAW_LAMBDA_FUNCTION --> SILVERTABLEJSON
CRAWL_CLEAN --> SILVERTABLECSV
JOB_JOIN --> GOLD

%% Catalog & consumption
GOLD --> GOLDDB
GOLDTABLE --> ANALYTICS

%% ─────────────────────────── STYLES ───────────────────────────
classDef lake fill:#E3F2FD,stroke:#90CAF9,stroke-width:1px,color:#0D47A1;
classDef catalog fill:#FFF8E1,stroke:#FFECB3,stroke-width:1px,color:#5D4037;
classDef db fill:#FFF9C4,stroke:#FDD835,color:#5D4037;
classDef lambda fill:#FFCDD2,stroke:#EF9A9A,color:#B71C1C;
classDef jobs fill:#E1BEE7,stroke:#CE93D8,color:#4A148C;
classDef crawler fill:#EDE7F6,stroke:#D1C4E9,color:#311B92;
classDef ext fill:#F1F8E9,stroke:#C5E1A5,color:#33691E;
classDef analytics fill:#E0F7FA,stroke:#80DEEA,color:#006064;
classDef event fill:#FFF3E0,stroke:#FFCC80,color:#E65100;

class DataLake lake;
class DataCatalog catalog;
class BRONZEDB,SILVERDB,GOLDDB db;
class Ingestion,RAW_ORCH,CLEAN_ORCH lambda;
class RAW_JOBS,CLEAN_JOBS jobs;
class RAW_CRAWLERS,CLEAN_CRAWLERS crawler;
class API ext;
class ANALYTICS analytics;
class S3EVT_RAW,S3EVT_CLEAN event;

linkStyle default stroke:#9E9E9E,stroke-width:1.2px,opacity:0.9;

